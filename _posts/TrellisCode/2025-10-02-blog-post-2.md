---
title: 'trellis3d-code3'
date: 2025-10-02
permalink: /posts/2025/10/blog-post-2/
tags:
series: TrellisCode
---

# Code for Trellis3D - Dataset3
======

code parts:

- dataset loading
- raw data processing
- feature extraction

Dataset
=======

TRELLIS-main/dataset_toolkits

- codes function
- default parameters
- data structure

3. voxelization

```python
def safe_create_from_triangle_mesh_within_bounds(mesh, voxel_size, min_bound, max_bound):
    """
    替代 create_from_triangle_mesh_within_bounds, 保证 voxel index 在 [0, 64) 内
    """
    # 1. 预处理 mesh
    mesh.remove_duplicated_vertices()
    mesh.remove_degenerate_triangles()
    mesh.remove_non_manifold_edges()
    mesh.remove_duplicated_triangles()

    # 2. 归一化到 [min_bound, max_bound]
    vertices = np.asarray(mesh.vertices)
    min_v = vertices.min(axis=0)
    max_v = vertices.max(axis=0)

    # 当前 mesh 的中心 & 尺度
    center = (min_v + max_v) / 2.0
    scale = np.max(max_v - min_v)  # 最大边长

    # 映射到 [-0.5, 0.5]
    vertices = (vertices - center) / scale

    # 目标中心与大小
    min_bound = np.array(min_bound, dtype=np.float32)
    max_bound = np.array(max_bound, dtype=np.float32)
    target_center = (min_bound + max_bound) / 2.0
    target_size = (max_bound - min_bound).max()

    # 再缩放到目标立方体大小
    vertices = vertices * target_size

    # 平移到目标中心
    offset = target_center - np.mean(vertices, axis=0)
    vertices = vertices + offset

    # 最后夹紧, 避免浮点误差导致的越界
    eps = 1e-6
    vertices = np.clip(vertices, min_bound + eps, max_bound - eps)

    # 更新回 mesh
    mesh.vertices = o3d.utility.Vector3dVector(vertices)

    # 3. 创建 voxel grid
    voxel_grid = o3d.geometry.VoxelGrid.create_from_triangle_mesh(mesh, voxel_size=voxel_size)
    return voxel_grid


def write_ply(path, vertices):
    """
    保存点云到 PLY 文件
    vertices: Nx3 numpy array
    """
    pcd = o3d.geometry.PointCloud()
    pcd.points = o3d.utility.Vector3dVector(vertices)
    o3d.io.write_point_cloud(path, pcd)

def _voxelize(file, sha256, output_dir):
    mesh = o3d.io.read_triangle_mesh(os.path.join(output_dir, 'renders', sha256, 'mesh.ply'))
    # clamp vertices to the range [-0.5, 0.5]
    vertices = np.clip(np.asarray(mesh.vertices), -0.5 + 1e-6, 0.5 - 1e-6)
    mesh.vertices = o3d.utility.Vector3dVector(vertices)
    print(mesh)
    # voxel_grid = o3d.geometry.VoxelGrid.create_from_triangle_mesh_within_bounds(mesh, voxel_size=1/64, min_bound=(-0.5, -0.5, -0.5), max_bound=(0.5, 0.5, 0.5))
    
    voxel_grid = safe_create_from_triangle_mesh_within_bounds(mesh, voxel_size=1/64, min_bound=(-0.5, -0.5, -0.5), max_bound=(0.5, 0.5, 0.5))
    vertices = np.array([voxel.grid_index for voxel in voxel_grid.get_voxels()])
    assert np.all(vertices >= 0) and np.all(vertices < 64), "Some vertices are out of bounds"
    vertices = (vertices + 0.5) / 64 - 0.5
    utils3d.numpy.io.write_ply(os.path.join(output_dir, 'voxels', f'{sha256}.ply'), vertices)
    return {'sha256': sha256, 'voxelized': True, 'num_voxels': len(vertices)}


if __name__ == '__main__':
    # dataset_utils = importlib.import_module(f'datasets.{sys.argv[1]}')
    dataset_utils = importlib.import_module(f'datasets.ABO')

    parser = argparse.ArgumentParser()
    parser.add_argument('--output_dir', type=str, default="/mnt/data/zsy/datasets/3D/ABO",
                        help='Directory to save the metadata')
    parser.add_argument('--filter_low_aesthetic_score', type=float, default=None,
                        help='Filter objects with aesthetic score lower than this value')
    parser.add_argument('--instances', type=str, default=None,
                        help='Instances to process')
    parser.add_argument('--num_views', type=int, default=150,
                        help='Number of views to render')
    dataset_utils.add_args(parser)
    parser.add_argument('--rank', type=int, default=0)
    parser.add_argument('--world_size', type=int, default=1)
    parser.add_argument('--max_workers', type=int, default=None)
    opt = parser.parse_args(sys.argv[2:])
    opt = edict(vars(opt))

    os.makedirs(os.path.join(opt.output_dir, 'voxels'), exist_ok=True)

    # get file list
    if not os.path.exists(os.path.join(opt.output_dir, 'metadata.csv')):
        raise ValueError('metadata.csv not found')
    metadata = pd.read_csv(os.path.join(opt.output_dir, 'metadata.csv'))
    if opt.instances is None:
        if opt.filter_low_aesthetic_score is not None:
            metadata = metadata[metadata['aesthetic_score'] >= opt.filter_low_aesthetic_score]
        if 'rendered' not in metadata.columns:
            raise ValueError('metadata.csv does not have "rendered" column, please run "build_metadata.py" first')
        metadata = metadata[metadata['rendered'] == True]
        if 'voxelized' in metadata.columns:
            metadata = metadata[metadata['voxelized'] == False]
    else:
        if os.path.exists(opt.instances):
            with open(opt.instances, 'r') as f:
                instances = f.read().splitlines()
        else:
            instances = opt.instances.split(',')
        metadata = metadata[metadata['sha256'].isin(instances)]

    start = len(metadata) * opt.rank // opt.world_size
    end = len(metadata) * (opt.rank + 1) // opt.world_size
    metadata = metadata[start:end]
    records = []

    # filter out objects that are already processed
    for sha256 in copy.copy(metadata['sha256'].values):
        if os.path.exists(os.path.join(opt.output_dir, 'voxels', f'{sha256}.ply')):
            pts = utils3d.io.read_ply(os.path.join(opt.output_dir, 'voxels', f'{sha256}.ply'))[0]
            records.append({'sha256': sha256, 'voxelized': True, 'num_voxels': len(pts)})
            metadata = metadata[metadata['sha256'] != sha256]
                
    print(f'Processing {len(metadata)} objects...')

    # process objects
    func = partial(_voxelize, output_dir=opt.output_dir)
    voxelized = dataset_utils.foreach_instance(metadata, opt.output_dir, func, max_workers=opt.max_workers, desc='Voxelizing')
    voxelized = pd.concat([voxelized, pd.DataFrame.from_records(records)])
    voxelized.to_csv(os.path.join(opt.output_dir, f'voxelized_{opt.rank}.csv'), index=False)
```
